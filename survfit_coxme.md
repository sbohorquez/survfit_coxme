Survival estimation Coxme
================

-   Using Efron for tied deaths
-   Using log for confidence intervals

``` r
require(coxme)
```

    ## Loading required package: coxme

    ## Loading required package: survival

    ## Loading required package: bdsmatrix

    ## 
    ## Attaching package: 'bdsmatrix'

    ## The following object is masked from 'package:base':
    ## 
    ##     backsolve

``` r
efron_me<-function(alpha,cox_me,i){
  
  if (ncol(cox_me$y)==3) {R_m<-which(cox_me$y[,1]<i &
                                    cox_me$y[,2]>=i)}
  else {R_m<-which(cox_me$y[,1]>=i)}
  D_j<-intersect(R_m, which(cox_me$y[,ncol(cox_me$y)]==1 &
                              cox_me$y[,(ncol(cox_me$y)-1)]==i ))
  
  rhs<-sum(exp(cox_me$linear.predictor[R_m]))

  lhs_exp<-exp(cox_me$linear.predictor[D_j])
  lhs<-sum(lhs_exp/(1-alpha^lhs_exp))
  
  return(abs(rhs-lhs))
}

alpha_j<-function(cox_me,j){
  op<-optim(0.5,efron_me, cox_me=cox_me, i=j,  method = "Brent",
            lower=0, upper=1, control=list(abstol=1e-8))
  return(op$par)
}

S0<-function(cox_me,t){
  alpha<-sapply(t,alpha_j,cox_me=cox_me)
  return(cumprod(alpha))
}

varlogst<-function(cox_me,i){
  if (ncol(cox_me$y)==3) {R_m<-which(cox_me$y[,1]<i &
                                    cox_me$y[,2]>=i)}
  else {R_m<-which(cox_me$y[,1]>=i)}
  D_j<-intersect(R_m, which(cox_me$y[,ncol(cox_me$y)]==1 &
                              cox_me$y[,(ncol(cox_me$y)-1)]==i ))
  
  rj<-length(R_m)
  dj<-length(D_j)
  return(dj/((rj-dj)*rj))
}



survfit.coxme<-function(cox_me,newdata=NULL){
  survfit<-list()
  survfit$n<-cox_me$n[2]
  events<-table(cox_me$y[,(ncol(cox_me$y)-1)],cox_me$y[,ncol(cox_me$y)])
  survfit$time<-as.numeric(rownames(events))
  rownames(events)<-c()
  survfit$n.risk<-cox_me$n[2]-cumsum(rowSums(events))
  survfit$n.event<-events[,2]
  survfit$n.censor<-events[,1]
  S0_est<-S0(cox_me,survfit$time)
  if (length(newdata)==0) {
    survfit$surv<-S0_est^(exp(sum(cox_me$means*cox_me$coefficients))) 
  }
   
  else {
    data_est<-data.matrix(newdata[,names(cox_me$coefficients)])%*%cox_me$coefficients
    survfit$surv<-sapply(data_est,function(x,y) y^(exp(x)),y=S0_est)
    survfit$time<-unique(cox_me$y[which(cox_me$y[,ncol(cox_me$y)]==1),
                     (ncol(cox_me$y)-1)])
  }
  survfit$type<-attr(cox_me$y,"type")
  survfit$cumhaz<- -log(survfit$surv)
  var<-cumsum(sapply(survfit$time,varlogst,cox_me=cox_me))
  survfit$std.err<-sqrt(var)
  survfit$upper<-survfit$surv*exp(qnorm(0.975)*survfit$std.err)
  survfit$upper[survfit$upper>1]<-1
  survfit$lower<-survfit$surv*exp(-qnorm(0.975)*survfit$std.err)
  survfit$conf.type<-"log"
  survfit$conf.int<-0.95
  survfit$call<-match.call()
  attr(survfit,"class")<-c("survfit.cox","survfit")
 return(survfit)
  
}

lung_coxme<-coxme(Surv(time,status)~age+sex+(1|inst),data=lung)
summary(lung_coxme)
```

    ## Cox mixed-effects model fit by maximum likelihood
    ##   Data: lung
    ##   events, n = 164, 227 (1 observation deleted due to missingness)
    ##   Iterations= 5 22 
    ##                     NULL Integrated    Fitted
    ## Log-likelihood -744.7999  -737.8121 -737.8009
    ## 
    ##                   Chisq   df          p  AIC   BIC
    ## Integrated loglik 13.98 3.00 0.00293850 7.98 -1.32
    ##  Penalized loglik 14.00 2.01 0.00092769 9.97  3.74
    ## 
    ## Model:  Surv(time, status) ~ age + sex + (1 | inst) 
    ## Fixed coefficients
    ##            coef exp(coef)    se(coef)     z      p
    ## age  0.01703526 1.0171812 0.009233008  1.85 0.0650
    ## sex -0.51167566 0.5994902 0.167681629 -3.05 0.0023
    ## 
    ## Random effects
    ##  Group Variable  Std Dev      Variance    
    ##  inst  Intercept 9.110830e-03 8.300722e-05

``` r
jaja<-survfit(lung_coxme)
summary(jaja)
```

    ## Call: survfit.coxme(cox_me = lung_coxme)
    ## 
    ##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
    ##     5    226       1   0.9958 0.00440       0.9872        1.000
    ##    11    223       3   0.9831 0.00874       0.9662        1.000
    ##    12    222       1   0.9789 0.00975       0.9600        0.998
    ##    13    220       2   0.9704 0.01149       0.9482        0.993
    ##    15    219       1   0.9662 0.01226       0.9424        0.990
    ##    26    218       1   0.9619 0.01297       0.9368        0.988
    ##    30    217       1   0.9576 0.01364       0.9312        0.985
    ##    31    216       1   0.9533 0.01428       0.9258        0.982
    ##    53    214       2   0.9447 0.01545       0.9149        0.976
    ##    54    213       1   0.9404 0.01600       0.9096        0.972
    ##    59    212       1   0.9361 0.01653       0.9043        0.969
    ##    60    210       2   0.9275 0.01751       0.8938        0.962
    ##    61    209       1   0.9232 0.01798       0.8886        0.959
    ##    62    208       1   0.9188 0.01843       0.8834        0.956
    ##    65    206       2   0.9102 0.01929       0.8732        0.949
    ##    71    205       1   0.9059 0.01970       0.8681        0.945
    ##    79    204       1   0.9016 0.02009       0.8630        0.942
    ##    81    202       2   0.8929 0.02085       0.8530        0.935
    ##    88    200       2   0.8843 0.02157       0.8430        0.928
    ##    92    198       1   0.8800 0.02191       0.8381        0.924
    ##    93    197       1   0.8756 0.02225       0.8331        0.920
    ##    95    195       2   0.8670 0.02290       0.8232        0.913
    ##   105    193       1   0.8626 0.02321       0.8183        0.909
    ##   107    191       2   0.8539 0.02382       0.8084        0.902
    ##   110    190       1   0.8495 0.02411       0.8035        0.898
    ##   116    189       1   0.8451 0.02440       0.7986        0.894
    ##   118    188       1   0.8407 0.02468       0.7937        0.891
    ##   122    187       1   0.8363 0.02495       0.7888        0.887
    ##   131    186       1   0.8319 0.02522       0.7839        0.883
    ##   132    184       2   0.8231 0.02573       0.7742        0.875
    ##   135    183       1   0.8188 0.02598       0.7694        0.871
    ##   142    182       1   0.8144 0.02623       0.7645        0.867
    ##   144    181       1   0.8100 0.02646       0.7597        0.864
    ##   145    179       2   0.8012 0.02692       0.7501        0.856
    ##   147    178       1   0.7968 0.02714       0.7453        0.852
    ##   153    177       1   0.7924 0.02736       0.7405        0.848
    ##   156    175       2   0.7836 0.02778       0.7310        0.840
    ##   163    172       3   0.7703 0.02837       0.7167        0.828
    ##   166    170       2   0.7615 0.02875       0.7072        0.820
    ##   167    169       1   0.7571 0.02893       0.7024        0.816
    ##   170    168       1   0.7527 0.02910       0.6977        0.812
    ##   175    164       1   0.7482 0.02928       0.6929        0.808
    ##   176    163       1   0.7437 0.02946       0.6881        0.804
    ##   177    161       1   0.7392 0.02963       0.6833        0.800
    ##   179    159       2   0.7301 0.02997       0.6736        0.791
    ##   180    158       1   0.7255 0.03013       0.6688        0.787
    ##   181    156       2   0.7164 0.03044       0.6592        0.779
    ##   182    155       1   0.7119 0.03059       0.6543        0.774
    ##   183    154       1   0.7073 0.03074       0.6495        0.770
    ##   186    152       1   0.7027 0.03089       0.6447        0.766
    ##   189    150       1   0.6981 0.03103       0.6398        0.762
    ##   194    147       1   0.6934 0.03118       0.6349        0.757
    ##   197    144       1   0.6887 0.03133       0.6299        0.753
    ##   199    143       1   0.6839 0.03148       0.6249        0.748
    ##   201    141       2   0.6744 0.03176       0.6150        0.740
    ##   202    139       1   0.6697 0.03189       0.6100        0.735
    ##   207    137       1   0.6649 0.03203       0.6050        0.731
    ##   208    136       1   0.6601 0.03217       0.6000        0.726
    ##   210    135       1   0.6553 0.03230       0.5950        0.722
    ##   212    133       1   0.6505 0.03243       0.5899        0.717
    ##   218    132       1   0.6457 0.03255       0.5849        0.713
    ##   222    129       1   0.6408 0.03268       0.5798        0.708
    ##   223    128       1   0.6358 0.03280       0.5747        0.703
    ##   226    124       1   0.6308 0.03293       0.5694        0.699
    ##   229    123       1   0.6257 0.03306       0.5642        0.694
    ##   230    122       1   0.6206 0.03318       0.5589        0.689
    ##   239    118       2   0.6103 0.03342       0.5482        0.679
    ##   245    115       1   0.6051 0.03355       0.5428        0.675
    ##   246    114       1   0.5998 0.03367       0.5374        0.670
    ##   267    110       1   0.5945 0.03380       0.5318        0.665
    ##   268    109       1   0.5891 0.03392       0.5263        0.660
    ##   269    107       1   0.5838 0.03404       0.5207        0.654
    ##   270    106       1   0.5784 0.03416       0.5151        0.649
    ##   283    102       1   0.5728 0.03429       0.5094        0.644
    ##   284    100       1   0.5672 0.03441       0.5036        0.639
    ##   285     98       2   0.5558 0.03465       0.4919        0.628
    ##   286     97       1   0.5501 0.03475       0.4861        0.623
    ##   288     96       1   0.5445 0.03485       0.4803        0.617
    ##   291     95       1   0.5387 0.03495       0.4744        0.612
    ##   293     92       1   0.5329 0.03505       0.4685        0.606
    ##   301     88       1   0.5270 0.03515       0.4624        0.601
    ##   303     86       1   0.5209 0.03525       0.4562        0.595
    ##   305     85       1   0.5148 0.03535       0.4500        0.589
    ##   306     84       1   0.5087 0.03545       0.4437        0.583
    ##   310     82       2   0.4963 0.03561       0.4312        0.571
    ##   320     80       1   0.4901 0.03569       0.4249        0.565
    ##   337     78       1   0.4838 0.03576       0.4186        0.559
    ##   340     77       1   0.4776 0.03584       0.4123        0.553
    ##   345     76       1   0.4713 0.03590       0.4060        0.547
    ##   348     75       1   0.4651 0.03596       0.3997        0.541
    ##   350     74       1   0.4589 0.03601       0.3935        0.535
    ##   351     73       1   0.4528 0.03606       0.3873        0.529
    ##   353     71       2   0.4404 0.03612       0.3750        0.517
    ##   361     69       1   0.4341 0.03615       0.3688        0.511
    ##   363     67       2   0.4216 0.03619       0.3563        0.499
    ##   364     65       1   0.4153 0.03619       0.3501        0.493
    ##   371     63       2   0.4026 0.03619       0.3376        0.480
    ##   387     59       1   0.3961 0.03622       0.3311        0.474
    ##   390     58       1   0.3895 0.03624       0.3246        0.467
    ##   394     57       1   0.3829 0.03625       0.3181        0.461
    ##   426     54       1   0.3760 0.03625       0.3113        0.454
    ##   428     53       1   0.3691 0.03625       0.3044        0.447
    ##   429     52       1   0.3621 0.03622       0.2976        0.441
    ##   433     51       1   0.3551 0.03619       0.2908        0.434
    ##   442     50       1   0.3482 0.03615       0.2841        0.427
    ##   444     48       1   0.3412 0.03608       0.2773        0.420
    ##   450     47       1   0.3340 0.03602       0.2704        0.413
    ##   455     46       1   0.3269 0.03594       0.2635        0.405
    ##   457     45       1   0.3197 0.03585       0.2566        0.398
    ##   460     43       1   0.3123 0.03574       0.2495        0.391
    ##   473     42       1   0.3048 0.03562       0.2424        0.383
    ##   477     41       1   0.2974 0.03548       0.2354        0.376
    ##   519     38       1   0.2896 0.03536       0.2279        0.368
    ##   520     37       1   0.2818 0.03522       0.2206        0.360
    ##   524     35       2   0.2662 0.03488       0.2059        0.344
    ##   533     33       1   0.2583 0.03471       0.1985        0.336
    ##   550     31       1   0.2503 0.03456       0.1909        0.328
    ##   558     29       1   0.2419 0.03440       0.1831        0.320
    ##   567     27       1   0.2334 0.03425       0.1750        0.311
    ##   574     26       1   0.2247 0.03405       0.1670        0.302
    ##   583     25       1   0.2160 0.03381       0.1589        0.294
    ##   613     23       1   0.2068 0.03355       0.1505        0.284
    ##   624     22       1   0.1976 0.03323       0.1421        0.275
    ##   641     21       1   0.1884 0.03287       0.1338        0.265
    ##   643     20       1   0.1791 0.03246       0.1256        0.256
    ##   654     19       1   0.1698 0.03198       0.1174        0.246
    ##   655     18       1   0.1605 0.03145       0.1093        0.236
    ##   687     17       1   0.1512 0.03086       0.1014        0.226
    ##   689     16       1   0.1420 0.03023       0.0935        0.215
    ##   705     15       1   0.1328 0.02954       0.0859        0.205
    ##   707     14       1   0.1236 0.02880       0.0783        0.195
    ##   728     13       1   0.1145 0.02799       0.0709        0.185
    ##   731     12       1   0.1055 0.02714       0.0637        0.175
    ##   735     11       1   0.0967 0.02625       0.0568        0.165
    ##   765      9       1   0.0876 0.02552       0.0495        0.155
    ##   791      8       1   0.0787 0.02472       0.0425        0.146
    ##   814      6       1   0.0684 0.02395       0.0344        0.136
    ##   883      3       1   0.0530 0.02406       0.0218        0.129

``` r
plot(jaja)
```

![](survfit_coxme_files/figure-markdown_github/unnamed-chunk-1-1.png)

Things to fix:

-   Factors not supported
-   Only works with Efron and log
-   Faster ways to do it
